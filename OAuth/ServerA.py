# server_a.py
from flask import Flask, request, redirect, make_response, render_template_string
import requests

app = Flask(__name__)
SERVER_B_URL = 'http://localhost:5001'

@app.route('/')
def home():
    token = request.cookies.get('token')
    if not token:
        return render_template_string('''
            <h1>Welcome to Server A</h1>
            <a href="/login">Login with Server B</a>
        ''')
    else:
        response = requests.get(f"{SERVER_B_URL}/verifyToken?token={token}")
        data = response.json()
        if data.get('status') == 'success':
            return render_template_string('''
                <h1>Logged In</h1>
                <p>Welcome! You are authenticated.</p>
            ''')
    return render_template_string('''
            <h1>Welcome to Server A</h1>
            <a href="/login">Login with Server B</a>
        ''')

@app.route('/login')
def login():
    redirect_url = 'http://localhost:5000/callback'
    return redirect(f"{SERVER_B_URL}/authenticate?comingFrom=serverA&redirectTo={redirect_url}")

@app.route('/callback')
def callback():
    token = request.args.get('token')
    if token:
        response = make_response(redirect('/'))
        response.set_cookie('token', token, httponly=True)
        return response
    return 'Error: No token received', 400

if __name__ == '__main__':
    app.run(port=5000)
