from flask import Flask, request, redirect, make_response, render_template
import requests

app = Flask(__name__)
OAUTH_URL = 'http://127.0.0.1:5002'

posts = {}

@app.route('/')
def home():
    token = request.cookies.get('token')
    if not token:
        return render_template('indexA.html')
    else:
        response = requests.get(f"{OAUTH_URL}/verifyToken?token={token}")
        data = response.json()
        if data.get('status') == 'success':
            username = data['data']['username']
            if username not in posts:
                posts[username] = []
                posts[username].append({'title': 'Welcome to your Bulletin Board!', 'content': 'Enjoy!'})
            user_posts = posts.get(username, [])
            return render_template('posts.html', username=username, user_posts=user_posts)
        else:
            return redirect('/logout')

@app.route('/login')
def login():
    redirect_url = 'http://127.0.0.1:5000/callback'
    return redirect(f"http://127.0.0.1:5001/login?redirectTo={redirect_url}")

@app.route('/callback')
def callback():
    token = request.args.get('token')
    if token:
        response = make_response(redirect('/'))
        response.set_cookie('token', token, httponly=True)
        return response
    return 'Error: No token received', 400

@app.route('/logout')
def logout():
    response = make_response(redirect('/'))
    response.delete_cookie('token')
    return response

@app.route('/new_post', methods=['GET', 'POST'])
def new_post():
    if request.method == 'POST':
        title = request.form['title']
        content = request.form['content']
        token = request.cookies.get('token')
        response = requests.get(f"{OAUTH_URL}/verifyToken?token={token}")
        data = response.json()
        print (data)
        if data.get('status') == 'success':
            username = data['data']['username']
            if username not in posts:
                posts[username] = []
            posts[username].append({'title': title, 'content': content})
        return redirect('/')
    else:
        return render_template('post_form.html')

if __name__ == '__main__':
    app.run(port=5000)